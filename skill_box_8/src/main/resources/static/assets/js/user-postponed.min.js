var max = 10;
var offset = 0;
var books = [];

$(document).ready(function() {

    offset = 0;
    max = $('#load-books').attr('max')

    $.ajax({
        url: `/api/user/info`,
        type: 'GET',
        dataType: 'json',
    }).then(function(data) {
        loadBooks()
    });
});

function changeDate() {
    offset = 0;
    $('#cards-block').empty();
}

function loadBooks() {

    const startDate = $('#start-date').val()
    const endDate = $('#end-date').val()

    $.ajax({
        url: `/api/user/postponed/list`,
        data: {"offset": offset, "limit": max},
        type: 'GET',
        dataType: 'json',
    }).then(function(data) {

        offset++;

        if (data.isLast || data.books.length == 0) {
            $("#load-books").hide();
            return
        } else {
            $("#load-books").show();
        }

        books.push(data.books);

        for (const book of data.books) {
            $('#cards-block').append(
                '<div class="Card">'+
                `    <div class="Card-picture"><a href="/books/${book.id}"><img src="/assets/img/content/main/card.jpg" alt="card.jpg"/></a>` +
                '    </div>' +
                '    <div class="Card-content">' +
                `        <strong class="Card-title"><a href="#">${book.title}</a>` +
                '        </strong>' +
                `        <div class="Card-description">${book.fioAuthor}` +
                '        </div>' +
                `        <div class="Card-cost"><span class="Card-price">${book.price}</span>` +
                '        </div>' +
                `        <button id="delete-book-${book.id}"` +
                '                    class="btn btn_primary btn_outline"' +
                '                    class="btn-content">Удалить</span>\n' +
                '        </button>' +
                '    </div>' +
                '</div>');

            const idButton = `delete-book-${book.id}`
            $(`#${idButton}`).click(function(event) {

                $.ajax({
                    url: `/api/user/postponed/delete/${event.target.id.split('-').pop()}`,
                    type: 'POST',
                    dataType: 'json',
                    async: false
                });

                offset = 0;
                max = $('#load-books').attr('max')
                $('#cards-block').empty();

                loadBooks()
            })
        }
    });
}

function deleteBook(id) {

    $.ajax({
        url: `/api/user/postponed/delete/${id.split('-').pop()}`,
        type: 'POST',
        dataType: 'json',
    }).then(function(data) {

        offset = 0;
        max = $('#load-books').attr('max')
        $('#cards-block').empty();

        loadBooks()
    });
}